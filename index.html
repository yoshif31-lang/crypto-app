<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Crypto Terminal</title>
    <script src="https://unpkg.com/lightweight-charts@4.1.1/dist/lightweight-charts.standalone.production.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #000000; color: #ffffff; margin: 0; padding: 5px; font-family: sans-serif; overflow-x: hidden; }
        .chart-pane { width: 100%; border: 1px solid #1a1a1a; margin-bottom: 2px; background: #000; }
        .indicator-label { position: absolute; left: 10px; z-index: 10; font-size: 10px; pointer-events: none; background: rgba(0,0,0,0.5); }
        button.active { background: #2b3139 !important; color: white !important; }
    </style>
</head>
<body>
    <div class="flex flex-wrap gap-2 items-center mb-2 px-1">
        <select id="symbolSelect" class="bg-zinc-900 text-white border border-zinc-700 p-2 rounded text-sm font-bold">
            <option value="BTCUSDT">BTC/USDT</option>
            <option value="SOLUSDT">SOL/USDT</option>
            <option value="MNTUSDT">MNT/USDT</option>
            <option value="ETHUSDT">ETH/USDT</option>
        </select>
        <div id="priceDisplay" class="text-xl font-bold text-yellow-500 ml-auto">---</div>
    </div>

    <div class="flex gap-1 mb-2 overflow-x-auto pb-1 no-scrollbar text-[10px]">
        <button onclick="changeInterval('1')" id="btn-1" class="bg-zinc-800 px-3 py-1 rounded text-zinc-400">1m</button>
        <button onclick="changeInterval('15')" id="btn-15" class="bg-zinc-800 px-3 py-1 rounded text-zinc-400 active">15m</button>
        <button onclick="changeInterval('30')" id="btn-30" class="bg-zinc-800 px-3 py-1 rounded text-zinc-400">30m</button>
        <button onclick="changeInterval('60')" id="btn-60" class="bg-zinc-800 px-3 py-1 rounded text-zinc-400">1h</button>
        <button onclick="changeInterval('240')" id="btn-240" class="bg-zinc-800 px-3 py-1 rounded text-zinc-400">4h</button>
        <button onclick="changeInterval('D')" id="btn-D" class="bg-zinc-800 px-3 py-1 rounded text-zinc-400">1d</button>
    </div>

    <div class="relative">
        <div id="mainChart" class="chart-pane h-[350px]"></div>
        <div class="indicator-label top-2 text-zinc-400">MA(5,10,20) VOL</div>
    </div>
    
    <div class="relative">
        <div id="rsiChart" class="chart-pane h-[80px]"></div>
        <div class="indicator-label top-1 text-blue-400">RSI(6,12)</div>
    </div>

    <div class="relative">
        <div id="macdChart" class="chart-pane h-[80px]"></div>
        <div class="indicator-label top-1 text-green-400">MACD(12,26,9)</div>
    </div>

    <div id="status" class="text-[10px] text-emerald-500 text-center py-2">Real-time Connected</div>

    <script>
        let currentSymbol = 'BTCUSDT', currentInterval = '15', ws;
        const charts = {};

        // Indicator Calculations
        const calcSMA = (data, p) => data.map((d, i) => {
            if (i < p - 1) return { time: d.time };
            const val = data.slice(i - p + 1, i + 1).reduce((s, c) => s + c.close, 0) / p;
            return { time: d.time, value: val };
        });

        const calcRSI = (data, p) => {
            let res = [];
            for (let i = 0; i < data.length; i++) {
                if (i < p) { res.push({ time: data[i].time }); continue; }
                let up = 0, down = 0;
                for (let j = i - p + 1; j <= i; j++) {
                    let diff = data[j].close - data[j - 1].close;
                    if (diff > 0) up += diff; else down -= diff;
                }
                res.push({ time: data[i].time, value: 100 - (100 / (1 + (up / down))) });
            }
            return res;
        };

        function createPane(id, height) {
            const chart = LightweightCharts.createChart(document.getElementById(id), {
                layout: { background: { color: '#000000' }, textColor: '#71717a' },
                grid: { vertLines: { color: '#111' }, horzLines: { color: '#111' } },
                timeScale: { visible: id === 'macdChart', borderColor: '#222' },
                rightPriceScale: { borderColor: '#222', scaleMargins: { top: 0.1, bottom: 0.1 } }
            });
            return chart;
        }

        function init() {
            const main = createPane('mainChart');
            charts.main = main;
            charts.candles = main.addCandlestickSeries({ upColor: '#089981', downColor: '#f23645', wickUpColor: '#089981', wickDownColor: '#f23645' });
            charts.vol = main.addHistogramSeries({ color: '#26a69a', priceFormat: { type: 'volume' }, priceScaleId: '', scaleMargins: { top: 0.8, bottom: 0 } });
            charts.ma5 = main.addLineSeries({ color: '#ffffff', lineWidth: 1 });
            charts.ma10 = main.addLineSeries({ color: '#f0b90b', lineWidth: 1 });
            charts.ma20 = main.addLineSeries({ color: '#ff00ff', lineWidth: 1 });

            const rsiChart = createPane('rsiChart');
            charts.rsi = rsiChart.addLineSeries({ color: '#3b82f6', lineWidth: 1 });
            
            const macdChart = createPane('macdChart');
            charts.macdLine = macdChart.addLineSeries({ color: '#22c55e', lineWidth: 1 });
            charts.macdSig = macdChart.addLineSeries({ color: '#ef4444', lineWidth: 1 });
            charts.macdHist = macdChart.addHistogramSeries({ color: '#555' });

            syncCharts();
            load();
        }

        function syncCharts() {
            ['mainChart', 'rsiChart', 'macdChart'].forEach(id => {
                document.getElementById(id).addEventListener('mouseover', () => { /* Sync logic */ });
            });
        }

        async function load() {
            const res = await fetch(`https://api.bybit.com/v5/market/kline?category=linear&symbol=${currentSymbol}&interval=${currentInterval}&limit=200`);
            const json = await res.json();
            const data = json.result.list.map(d => ({
                time: parseInt(d[0]) / 1000, open: parseFloat(d[1]), high: parseFloat(d[2]), low: parseFloat(d[3]), close: parseFloat(d[4]), volume: parseFloat(d[5])
            })).reverse();

            charts.candles.setData(data);
            charts.vol.setData(data.map(d => ({ time: d.time, value: d.volume, color: d.close >= d.open ? '#08998155' : '#f2364555' })));
            charts.ma5.setData(calcSMA(data, 5));
            charts.ma10.setData(calcSMA(data, 10));
            charts.ma20.setData(calcSMA(data, 20));
            charts.rsi.setData(calcRSI(data, 14));
            
            // Basic MACD logic
            charts.macdLine.setData(data.map(d => ({time: d.time, value: 0}))); // Placeholder
            
            document.getElementById('priceDisplay').innerText = data[data.length-1].close.toLocaleString();
            connect();
        }

        function connect() {
            if (ws) ws.close();
            ws = new WebSocket('wss://stream.bybit.com/v5/public/linear');
            ws.onopen = () => ws.send(JSON.stringify({ op: 'subscribe', args: [`kline.${currentInterval}.${currentSymbol}`] }));
            ws.onmessage = (e) => {
                const msg = JSON.parse(e.data);
                if (msg.data) {
                    const k = msg.data[0];
                    const p = parseFloat(k.close);
                    document.getElementById('priceDisplay').innerText = p.toLocaleString();
                    charts.candles.update({ time: k.start/1000, open: parseFloat(k.open), high: parseFloat(k.high), low: parseFloat(k.low), close: p });
                }
            };
        }

        function changeInterval(v) {
            currentInterval = v;
            document.querySelectorAll('button').forEach(b => b.classList.remove('active'));
            document.getElementById('btn-'+v).classList.add('active');
            load();
        }

        document.getElementById('symbolSelect').onchange = (e) => { currentSymbol = e.target.value; load(); };
        window.onload = init;
    </script>
</body>
</html>
