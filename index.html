<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ultimate Crypto Terminal</title>
    <script src="https://unpkg.com/lightweight-charts@4.1.1/dist/lightweight-charts.standalone.production.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #000000; color: #ffffff; margin: 0; padding: 5px; font-family: sans-serif; overflow: hidden; }
        .chart-container { position: relative; width: 100%; border: 1px solid #1a1a1a; background: #000; margin-bottom: 2px; }
        .price-header { display: flex; justify-content: space-between; align-items: center; padding: 8px; background: #0b0e11; border-radius: 8px; margin-bottom: 6px; border: 1px solid #2b3139; }
        .legend-bar { position: absolute; left: 8px; top: 4px; z-index: 50; font-size: 10px; display: flex; flex-wrap: wrap; gap: 8px; pointer-events: none; white-space: nowrap; font-family: monospace; background: rgba(0,0,0,0.5); padding: 2px 4px; border-radius: 2px; }
        button.active { background: #2b3139 !important; color: white !important; border: 1px solid #474d57 !important; }
        .status-tag { font-size: 9px; padding: 1px 4px; border-radius: 3px; font-weight: bold; text-transform: uppercase; }
        ::-webkit-scrollbar { display: none; }
    </style>
</head>
<body>
    <div class="price-header">
        <select id="symbolSelect" class="bg-zinc-900 text-white border border-zinc-700 p-2 rounded text-sm font-bold outline-none">
            <option value="BTCUSDT">BTC/USDT</option>
            <option value="ETHUSDT">ETH/USDT</option>
            <option value="SOLUSDT">SOL/USDT</option>
            <option value="MNTUSDT">MNT/USDT</option>
        </select>
        <div class="text-right">
            <div id="priceDisplay" class="text-2xl font-bold text-yellow-500">---</div>
            <div id="connStatus" class="status-tag bg-zinc-800 text-zinc-500">Connecting...</div>
        </div>
    </div>

    <div class="flex gap-1 mb-2 overflow-x-auto pb-1 text-[10px]">
        <button onclick="changeInterval('1')" id="btn-1" class="bg-zinc-800 px-3 py-1.5 rounded text-zinc-400 border border-transparent">1m</button>
        <button onclick="changeInterval('15')" id="btn-15" class="bg-zinc-800 px-3 py-1.5 rounded text-zinc-400 active border border-transparent">15m</button>
        <button onclick="changeInterval('60')" id="btn-60" class="bg-zinc-800 px-3 py-1.5 rounded text-zinc-400 border border-transparent">1h</button>
        <button onclick="changeInterval('D')" id="btn-D" class="bg-zinc-800 px-3 py-1.5 rounded text-zinc-400 border border-transparent">1d</button>
    </div>

    <div class="chart-container h-[260px]"><div id="mainChart" class="w-full h-full"></div><div id="maLegend" class="legend-bar"></div></div>
    <div class="chart-container h-[60px]"><div id="volChart" class="w-full h-full"></div><div id="volLegend" class="legend-bar"></div></div>
    <div class="chart-container h-[60px]"><div id="rsiChart" class="w-full h-full"></div><div id="rsiLegend" class="legend-bar"></div></div>
    <div class="chart-container h-[60px]"><div id="kdjChart" class="w-full h-full"></div><div id="kdjLegend" class="legend-bar"></div></div>
    <div class="chart-container h-[60px]"><div id="macdChart" class="w-full h-full"></div><div id="macdLegend" class="legend-bar"></div></div>

    <script>
        let currentSymbol = 'BTCUSDT', currentInterval = '15', ws, allData = [];
        const charts = {}, series = {};

        const calcSMA = (data, p) => data.map((d, i) => (i < p-1) ? {time: d.time} : {time: d.time, value: data.slice(i-p+1, i+1).reduce((s, c) => s + c.close, 0)/p});
        const calcEMA = (data, p) => {
            let res = [], k = 2/(p+1);
            for(let i=0; i<data.length; i++){
                if(i<p-1) res.push({time: data[i].time});
                else if(i===p-1) res.push({time: data[i].time, value: data.slice(0, p).reduce((s, c) => s + c.close, 0)/p});
                else res.push({time: data[i].time, value: data[i].close*k + res[i-1].value*(1-k)});
            }
            return res;
        };

        function createChart(id, hasTime = false) {
            const chart = LightweightCharts.createChart(document.getElementById(id), {
                layout: { background: { color: '#000000' }, textColor: '#71717a', fontSize: 10 },
                grid: { vertLines: { color: '#000' }, horzLines: { color: '#111' } },
                timeScale: { visible: hasTime, borderColor: '#222', fixLeftEdge: true, rightOffset: 5 },
                rightPriceScale: { borderColor: '#222', autoScale: true },
                crosshair: { mode: 0 },
                handleScroll: true, handleScale: true
            });
            return chart;
        }

        function init() {
            charts.main = createChart('mainChart');
            series.candles = charts.main.addCandlestickSeries({ upColor: '#089981', downColor: '#f23645', wickUpColor: '#089981', wickDownColor: '#f23645' });
            
            const lineOpt = { lineWidth: 1, lastValueVisible: false, priceLineVisible: false };
            series.ma5 = charts.main.addLineSeries({ color: '#ffffff', ...lineOpt });
            series.ma10 = charts.main.addLineSeries({ color: '#f0b90b', ...lineOpt });
            series.ma20 = charts.main.addLineSeries({ color: '#ff00ff', ...lineOpt });
            series.ema50 = charts.main.addLineSeries({ color: '#3b82f6', ...lineOpt });

            charts.vol = createChart('volChart');
            series.vol = charts.vol.addHistogramSeries({ color: '#26a69a', priceFormat: { type: 'volume' }, lastValueVisible: false, priceLineVisible: false });

            charts.rsi = createChart('rsiChart');
            series.rsi = charts.rsi.addLineSeries({ color: '#3b82f6', ...lineOpt });

            charts.kdj = createChart('kdjChart');
            series.k = charts.kdj.addLineSeries({ color: '#ffffff', ...lineOpt });
            series.d = charts.kdj.addLineSeries({ color: '#f0b90b', ...lineOpt });

            charts.macd = createChart('macdChart', true);
            series.mLine = charts.macd.addLineSeries({ color: '#ffffff', ...lineOpt });

            const sync = [charts.main, charts.vol, charts.rsi, charts.kdj, charts.macd];
            
            // 自動リサイズ機能
            const resizeObserver = new ResizeObserver(() => {
                sync.forEach(c => {
                    const container = c.chartElement().parentElement;
                    c.applyOptions({ width: container.clientWidth, height: container.clientHeight });
                });
            });
            sync.forEach(c => resizeObserver.observe(c.chartElement().parentElement));

            sync.forEach(c => {
                c.timeScale().subscribeVisibleTimeRangeChange(r => sync.filter(o => o !== c).forEach(o => o.timeScale().setVisibleRange(r)));
                c.subscribeCrosshairMove(p => {
                    sync.filter(o => o !== c).forEach(o => o.setCrosshairPosition(p.paneAndPriceByScaleId, p.time, p.paneAndPriceByScaleId));
                    updateLegends(p.time);
                });
            });
            load();
        }

        function updateLegends(time) {
            const d = time ? allData.find(x => x.time === time) : allData[allData.length-1];
            if(!d) return;
            document.getElementById('maLegend').innerHTML = `<span style="color:#fff">MA5:${d.ma5?.toFixed(2)||'--'}</span> <span style="color:#f0b90b">MA10:${d.ma10?.toFixed(2)||'--'}</span> <span style="color:#ff00ff">MA20:${d.ma20?.toFixed(2)||'--'}</span> <span style="color:#3b82f6">E50:${d.ema50?.toFixed(2)||'--'}</span>`;
            document.getElementById('volLegend').innerHTML = `<span style="color:#26a69a">VOL:${d.volume?.toFixed(0)||'--'}</span>`;
            document.getElementById('rsiLegend').innerHTML = `<span style="color:#3b82f6">RSI(14):${d.rsi?.toFixed(2)||'--'}</span>`;
        }

        async function load() {
            setStatus('Loading...', 'bg-zinc-800 text-zinc-500');
            try {
                const res = await fetch(`https://api.bybit.com/v5/market/kline?category=linear&symbol=${currentSymbol}&interval=${currentInterval}&limit=150`);
                const json = await res.json();
                const raw = json.result.list.map(d => ({
                    time: parseInt(d[0])/1000, open: parseFloat(d[1]), high: parseFloat(d[2]), low: parseFloat(d[3]), close: parseFloat(d[4]), volume: parseFloat(d[5])
                })).reverse();

                const ma5 = calcSMA(raw, 5), ma10 = calcSMA(raw, 10), ma20 = calcSMA(raw, 20), ema50 = calcEMA(raw, 50);
                allData = raw.map((d, i) => ({ ...d, ma5: ma5[i].value, ma10: ma10[i].value, ma20: ma20[i].value, ema50: ema50[i].value, rsi: 50, k: 50, d: 50 }));

                series.candles.setData(raw);
                series.ma5.setData(ma5); series.ma10.setData(ma10); series.ma20.setData(ma20); series.ema50.setData(ema50);
                series.vol.setData(raw.map(d => ({time: d.time, value: d.volume, color: d.close >= d.open ? '#08998155' : '#f2364555'})));
                
                charts.main.timeScale().fitContent();
                updateLegends();
                document.getElementById('priceDisplay').innerText = "$" + raw[raw.length-1].close.toLocaleString();
                connect();
            } catch (e) { setStatus('Error', 'bg-red-900 text-red-200'); }
        }

        function setStatus(text, classes) {
            const s = document.getElementById('connStatus');
            s.innerText = text;
            s.className = 'status-tag ' + classes;
        }

        function connect() {
            if (ws) ws.close();
            ws = new WebSocket('wss://stream.bybit.com/v5/public/linear');
            ws.onopen = () => {
                setStatus('Live', 'bg-emerald-900 text-emerald-400');
                ws.send(JSON.stringify({ op: 'subscribe', args: [`kline.${currentInterval}.${currentSymbol}`] }));
            };
            ws.onmessage = (e) => {
                const msg = JSON.parse(e.data);
                if (msg.data) {
                    const k = msg.data[0];
                    const price = parseFloat(k.close).toLocaleString();
                    document.getElementById('priceDisplay').innerText = "$" + price;
                    series.candles.update({ time: k.start/1000, open: parseFloat(k.open), high: parseFloat(k.high), low: parseFloat(k.low), close: parseFloat(k.close) });
                }
            };
            ws.onerror = () => setStatus('Socket Error', 'bg-red-900 text-red-200');
            ws.onclose = () => { if(currentInterval !== 'LOADING') setStatus('Offline', 'bg-zinc-800 text-zinc-500'); };
        }

        function changeInterval(v) {
            if(v === currentInterval) return;
            currentInterval = v;
            document.querySelectorAll('button').forEach(b => b.classList.remove('active'));
            document.getElementById('btn-'+v).classList.add('active');
            // データクリア
            Object.values(series).forEach(s => s.setData([]));
            load();
        }

        document.getElementById('symbolSelect').onchange = (e) => { currentSymbol = e.target.value; load(); };
        window.onload = init;
    </script>
</body>
</html>
